<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筋肉成長記録</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <header>
        <h1 id="main-title">筋肉成長記録</h1>
    </header>

    <div id="user-auth-section" class="container">
        <h2>ログインまたは新規登録</h2>
        <div class="form-group">
            <label for="username-input">ユーザー名:</label>
            <input type="text" id="username-input" placeholder="例: muscle_taro">
        </div>
        
        <div class="button-group">
            <button id="login-button">決定</button>
            
        </div>
        <p id="auth-error" class="error-message"></p>
    </div>

    <main id="main-content" class="muscle-container" style="display: none;">
        <!-- Log Entry Form -->
        <section id="data-entry">
            <h2>今日の記録を追加</h2>
            <form id="workout-form">
                <div class="form-group"><label for="workout-date">日付:</label><input type="date" id="workout-date" required></div>
                <div class="form-group"><label for="workout-type">種目:</label><input type="text" id="workout-type" placeholder="例: ベンチプレス" required></div>
                <div class="form-group"><label for="weight">重量 (kg):</label><input type="number" id="weight" placeholder="例: 60" step="0.1" required></div>
                <div class="form-group"><label for="reps">回数:</label><input type="number" id="reps" placeholder="例: 10" required></div>
                <div class="form-group"><label for="notes">メモ:</label><textarea id="notes" placeholder="今日の感想や食事内容など"></textarea></div>
                <div class="form-group"><label for="photo">今日の写真:</label><input type="file" id="photo" accept="image/*"></div>
                <button type="submit">記録する</button>
            </form>
        </section>

        <!-- Personal Log View -->
        <section id="log-view">
            <h2>あなたのトレーニングログ</h2>
            <div id="log-list"></div>
        </section>

        <!-- Personal Gallery View -->
        <section id="gallery-view">
            <h2>あなたのフォトギャラリー</h2>
            <div id="photo-gallery"></div>
        </section>

        <!-- Personal Chart View -->
        <section id="chart-view">
            <h2>あなたの成長グラフ</h2>
            <div class="form-group"><label for="chart-exercise-select">種目を選択:</label><select id="chart-exercise-select"></select></div>
            <canvas id="progress-chart"></canvas>
        </section>
    </main>

    <!-- Other Users' Logs -->
    <section id="other-users-section" class="container" style="display: none;">
        <h2>他のユーザーの記録を見る</h2>
        <div class="form-group">
            <label for="other-user-select">ユーザーを選択:</label>
            <select id="other-user-select"></select>
        </div>
        <div id="other-user-logs"></div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State & Config ---
        let currentUser = null;
        const API_URL = 'http://127.0.0.1:8001';

        // --- DOM Elements ---
        const authSection = document.getElementById('user-auth-section');
        const mainContent = document.getElementById('main-content');
        const otherUsersSection = document.getElementById('other-users-section');
        
        const usernameInput = document.getElementById('username-input');
        const loginButton = document.getElementById('login-button');
        const authError = document.getElementById('auth-error');

        const mainTitle = document.getElementById('main-title');
        const form = document.getElementById('workout-form');
        const logList = document.getElementById('log-list');
        const photoGallery = document.getElementById('photo-gallery');
        const photoInput = document.getElementById('photo');
        const chartCanvas = document.getElementById('progress-chart');
        const exerciseSelect = document.getElementById('chart-exercise-select');
        const otherUserSelect = document.getElementById('other-user-select');
        const otherUserLogs = document.getElementById('other-user-logs');

        let progressChart = null;

        // --- API Communication ---
        const apiCall = async (endpoint, method = 'GET', body = null) => {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(`${API_URL}${endpoint}`, options);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'API Error');
            }
            return data;
        };

        // --- Rendering Functions ---
        const renderLogs = async (username, container) => {
            const logs = (await apiCall(`/logs/${username}`)).sort((a, b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = logs.length ? '' : '<p>まだ記録がありません。</p>';
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `<strong>${log.date}</strong><br><span>種目: ${log.type}</span><br><span>重量: ${log.weight} kg</span><br><span>回数: ${log.reps} 回</span><br><p>${log.notes || ''}</p>`;
                container.appendChild(logItem);
            });
        };

        const renderPersonalGallery = async () => {
            const logs = await apiCall(`/logs/${currentUser}`);
            const photos = logs.filter(log => log.photo).sort((a, b) => new Date(b.date) - new Date(a.date));
            photoGallery.innerHTML = photos.length ? '' : '<p>まだ写真がありません。</p>';
            photos.forEach(log => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.innerHTML = `<img src="${log.photo}" alt="${log.date}の写真"><p>${log.date}</p>`;
                photoGallery.appendChild(galleryItem);
            });
        };

        const populateExerciseSelect = async () => {
            const logs = await apiCall(`/logs/${currentUser}`);
            const uniqueExercises = [...new Set(logs.map(log => log.type))];
            exerciseSelect.innerHTML = '<option value="">-- 種目を選択 --</option>';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                exerciseSelect.appendChild(option);
            });
        };

        const renderChart = async () => {
            const logs = await apiCall(`/logs/${currentUser}`);
            const selectedExercise = exerciseSelect.value;
            if (!selectedExercise) {
                if(progressChart) progressChart.destroy();
                chartCanvas.style.display = 'none';
                return;
            }
            chartCanvas.style.display = 'block';
            const chartData = logs.filter(log => log.type === selectedExercise).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (progressChart) progressChart.destroy();
            progressChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.map(log => log.date),
                    datasets: [{
                        label: `${selectedExercise} の重量 (kg)`,
                        data: chartData.map(log => log.weight),
                        borderColor: '#39ff14', fill: true,
                    }]
                },
            });
        };

        const populateOtherUsers = async () => {
            const users = await apiCall('/users');
            otherUserSelect.innerHTML = '<option value="">-- ユーザーを選択 --</option>';
            users.filter(user => user !== currentUser).forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                otherUserSelect.appendChild(option);
            });
        };

        const renderAllPersonal = async () => {
            await renderLogs(currentUser, logList);
            await renderPersonalGallery();
            await populateExerciseSelect();
            await renderChart();
        };

        // --- Event Listeners ---
        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                authError.textContent = 'ユーザー名を入力してください。';
                return;
            }
            currentUser = username;
            authSection.style.display = 'none';
            mainContent.style.display = 'block';
            otherUsersSection.style.display = 'block';
            mainTitle.textContent = `${currentUser}の筋肉成長記録`;
            await renderAllPersonal();
            await populateOtherUsers();
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newLog = {
                date: document.getElementById('workout-date').value,
                type: document.getElementById('workout-type').value.trim(),
                weight: parseFloat(document.getElementById('weight').value),
                reps: parseInt(document.getElementById('reps').value),
                notes: document.getElementById('notes').value,
                photo: null
            };
            if (!newLog.date || !newLog.type) return alert('日付と種目は必須です。');

            const file = photoInput.files[0];
            const processSubmit = async (log) => {
                await apiCall(`/logs/${currentUser}`, 'POST', log);
                await renderAllPersonal();
                form.reset();
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    newLog.photo = event.target.result;
                    await processSubmit(newLog);
                };
                reader.readAsDataURL(file);
            } else {
                await processSubmit(newLog);
            }
        });

        exerciseSelect.addEventListener('change', renderChart);
        
        otherUserSelect.addEventListener('change', async (e) => {
            const selectedUser = e.target.value;
            if (selectedUser) {
                await renderLogs(selectedUser, otherUserLogs);
            } else {
                otherUserLogs.innerHTML = '';
            }
        });
    });
    </script>
</body>
</html>
